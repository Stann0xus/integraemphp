# INTEGRAEMPHP o PAGCOMPLETO 

Este projeto √© uma solu√ß√£o PHP para integrar um sistema de e-commerce com o gateway de pagamento PAGCOMPLETO. Ele automatiza o processamento de pedidos eleg√≠veis, gerencia o status no banco de dados e oferece uma interface web simples para monitoramento e controle.

## Objetivo do Projeto

O principal objetivo deste projeto √© demonstrar a capacidade de integrar um sistema de pedidos com um gateway de pagamento externo, o PAGCOMPLETO. A solu√ß√£o foca na automa√ß√£o do processo de verifica√ß√£o e atualiza√ß√£o do status de pagamentos de pedidos, garantindo a consist√™ncia dos dados e a seguran√ßa das opera√ß√µes.

## Contexto do Desafio
Um cliente acabou de contratar o nosso gateway de pagamento PAGCOMPLETO. A miss√£o ser√° integrar a API para que os pedidos possam ser processados corretamente, seguindo os crit√©rios t√©cnicos definidos.

## Caracter√≠sticas Principais

-  **Processamento Autom√°tico**: O sistema pode ser configurado para processar pedidos eleg√≠veis automaticamente (via cron job, por exemplo, embora a funcionalidade de timer n√£o esteja implementada diretamente no c√≥digo PHP, a arquitetura permite isso).
-  **Interface Web Simples**: Um dashboard intuitivo para monitoramento e controle manual das opera√ß√µes.
-  **Reset de Banco de Dados**: Funcionalidade para restaurar o banco de dados aos seus dados originais, ideal para ambientes de desenvolvimento e teste.
-  **Valida√ß√£o Rigorosa**: Verifica√ß√£o e normaliza√ß√£o de dados antes do envio para a API externa.
-  **Tratamento de Erros**: Gest√£o robusta de falhas e exce√ß√µes durante a comunica√ß√£o com a API e opera√ß√µes de banco de dados.
-  **Modo de Desenvolvimento Seguro**: Permite testar toda a l√≥gica de integra√ß√£o sem realizar chamadas reais √† API do PAGCOMPLETO, protegendo o ambiente externo.

## Arquitetura do Software

Este projeto segue uma arquitetura cliente-servidor tradicional, onde o PHP atua como a camada de aplica√ß√£o, interagindo com um banco de dados PostgreSQL e um servidor web Apache. A comunica√ß√£o com a API externa √© feita via cURL.

### Tecnologias Utilizadas:

-   **PHP 8.1+**: Linguagem de programa√ß√£o backend, com foco no uso de PDO (PHP Data Objects) para intera√ß√£o segura com o banco de dados, prevenindo ataques de SQL Injection.
-   **PostgreSQL 14+**: Sistema de gerenciamento de banco de dados relacional (DBServer), utilizado para armazenar os dados de pedidos, clientes, pagamentos e configura√ß√µes.
-   **Apache 2.4+**: Servidor web (WebServer) respons√°vel por servir as p√°ginas PHP e gerenciar as requisi√ß√µes HTTP.
-   **HTML5/CSS3/JavaScript (Bootstrap)**: Utilizados para a constru√ß√£o da interface de usu√°rio (frontend), garantindo um design responsivo e intuitivo. O Bootstrap √© empregado para agilizar o desenvolvimento da UI.
-   **cURL**: Biblioteca utilizada para realizar requisi√ß√µes HTTP de forma program√°tica, sendo a ferramenta escolhida para a comunica√ß√£o com a API do PAGCOMPLETO.

### M√©todo de Seguran√ßa:

-   **PDO com Prepared Statements**: Essencial para prevenir SQL Injection, garantindo que os dados inseridos ou consultados no banco de dados sejam tratados de forma segura.
-   **Valida√ß√£o dos Dados**: Implementa√ß√£o de valida√ß√µes para garantir a integridade e o formato correto dos dados antes do processamento.
-   **Tratativa de Erros**: Mecanismos robustos para lidar com exce√ß√µes e falhas, tanto nas opera√ß√µes de banco de dados quanto na comunica√ß√£o com a API.
-   **Logs sem Exposi√ß√£o de Dados Sens√≠veis**: As mensagens de log s√£o projetadas para n√£o expor informa√ß√µes confidenciais, protegendo a privacidade dos dados.

## Funcionalidades Nucleares (Main Features)

O sistema oferece as seguintes funcionalidades principais:

-   **Reset do Banco de Dados**: Um bot√£o na interface web permite recarregar o banco de dados com os dados originais de teste, facilitando o desenvolvimento e a depura√ß√£o.
-   **Dashboard**: Uma interface web que lista todos os pedidos do banco de dados, exibindo informa√ß√µes essenciais como ID do pedido, cliente, valor total, forma de pagamento, status e se o pedido √© eleg√≠vel para processamento pelo PAGCOMPLETO.
-   **Processamento Manual**: Um bot√£o na dashboard permite iniciar o processamento de pedidos eleg√≠veis sob demanda, enviando-os para a API do PAGCOMPLETO.
-   **Sistema de Mensagens**: Exibi√ß√£o de mensagens de feedback claras e concisas sobre o status das opera√ß√µes (sucesso, aviso, erro) diretamente na interface.
-   **Teste de Conex√£o**: Verifica√ß√£o autom√°tica da conectividade com o banco de dados na inicializa√ß√£o da dashboard.

## Crit√©rios de Elegibilidade

Para que um pedido seja considerado eleg√≠vel para processamento pelo gateway PAGCOMPLETO, ele deve atender aos seguintes crit√©rios:

1.  **Gateway PAGCOMPLETO**: Apenas lojas que utilizam o `id_gateway = 1` (PAGCOMPLETO).
2.  **Cart√£o de Cr√©dito**: Apenas pagamentos realizados via `id_formapagto = 3` (Cart√£o de Cr√©dito).
3.  **Aguardando Pagamento**: O status do pedido deve ser `id_situacao = 1` (Aguardando Pagamento).

Ap√≥s o processamento pela API, o status do pedido no banco de dados ser√° atualizado conforme o retorno da API (Pagamento Identificado ou Pedido Cancelado).

## ‚öôÔ∏è Instala√ß√£o e Configura√ß√£o

Este guia detalha os passos para configurar o ambiente necess√°rio e implantar o projeto em um servidor Ubuntu com Apache2 e PostgreSQL.

### Pr√©-requisitos

Certifique-se de ter acesso `sudo` no seu servidor Ubuntu.

### 1. Instala√ß√£o de Pacotes Essenciais

Primeiro, atualize os pacotes do sistema e instale o PostgreSQL, Apache2 e os m√≥dulos PHP necess√°rios:

```bash
sudo apt update
sudo apt install -y postgresql postgresql-contrib apache2 php libapache2-mod-php php-pgsql php-curl php-json
```

### 2. Configura√ß√£o do Apache2

Crie o diret√≥rio do projeto no Apache e ajuste as permiss√µes:

```bash
sudo systemctl start apache2
sudo systemctl enable apache2
sudo mkdir -p /var/www/html/pagcompleto
sudo chown -R $USER:$USER /var/www/html/pagcompleto
```

**Observa√ß√£o**: `$USER` deve ser substitu√≠do pelo seu usu√°rio no servidor (ex: `ubuntu`).

### 3. Configura√ß√£o do PostgreSQL

Inicie o servi√ßo PostgreSQL e configure o banco de dados e o usu√°rio para o projeto:

```bash
sudo systemctl start postgresql
sudo systemctl enable postgresql
sudo -i -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'postgres';"
sudo -i -u postgres psql -c "CREATE DATABASE pagcompleto_db;"
sudo -i -u postgres psql -c "CREATE USER pagcompleto_user WITH ENCRYPTED PASSWORD 'pagcompleto_password';"
sudo -i -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE pagcompleto_db TO pagcompleto_user;"

## Conceder permiss√µes adicionais para o usu√°rio do banco de dados
## (Necess√°rio para opera√ß√µes como o reset do banco, que manipulam schemas e tabelas) - N√£o recomendado!
## A forma como implementei o reset de tabelas requer permiss√µes de superuser. Existem formas mais apropriadas.
sudo -u postgres psql -d pagcompleto_db -c "GRANT USAGE, CREATE ON SCHEMA public TO pagcompleto_user; ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO pagcompleto_user; ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO pagcompleto_user;"
```

### 4. Implanta√ß√£o do Projeto

1.  **Copie os arquivos do projeto** (config.php, index.php, process.php, reset.php) para o diret√≥rio `/var/www/html/pagcompleto/`.
2.  **Crie o diret√≥rio `sql/`** dentro de `/var/www/html/pagcompleto/` e copie todos os arquivos `.sql` fornecidos para dentro dele.

    ```bash
    sudo mkdir -p /var/www/html/pagcompleto/sql
    # Copie seus arquivos .sql para este diret√≥rio
    # Exemplo: sudo cp /caminho/para/seus/arquivos/*.sql /var/www/html/pagcompleto/sql/
    ```

3.  **Ajuste as permiss√µes** dos arquivos PHP:

    ```bash
    sudo chown -R www-data:www-data /var/www/html/pagcompleto
    sudo chmod -R 755 /var/www/html/pagcompleto
    ```

### 5. Configura√ß√£o do PHP

Para gerar verbose quanto para o PHP (e demonstrar melhor quaisquer erros com mais detalhes):
Verifique se o `php.ini` est√° configurado corretamente para exibir erros durante o desenvolvimento:

```bash
sudo nano /etc/php/8.1/apache2/php.ini # ou a vers√£o do seu PHP
```

Procure por:

```ini
display_errors = Off
```

E mude para:

```ini
display_errors = On
```

Salve e feche o arquivo, e reinicie o Apache:

```bash
sudo systemctl restart apache2
```


## Estrutura de Arquivos

O projeto possui uma estrutura de arquivos simples e direta, facilitando a compreens√£o e manuten√ß√£o:

```
pagcompleto/
‚îú‚îÄ‚îÄ config.php
‚îú‚îÄ‚îÄ index.php
‚îú‚îÄ‚îÄ process.php
‚îú‚îÄ‚îÄ reset.php
‚îî‚îÄ‚îÄ sql/
    ‚îú‚îÄ‚îÄ clientes.sql
    ‚îú‚îÄ‚îÄ formas_pagamento.sql
    ‚îú‚îÄ‚îÄ gateways.sql
    ‚îú‚îÄ‚îÄ lojas_gateway.sql
    ‚îú‚îÄ‚îÄ pedido_situacao.sql
    ‚îú‚îÄ‚îÄ pedidos.sql
    ‚îî‚îÄ‚îÄ pedidos_pagamentos.sql
```

-   `config.php`: Cont√©m as configura√ß√µes de conex√£o com o banco de dados, credenciais da API e o modo de desenvolvimento.
-   `index.php`: A interface web principal (dashboard) que exibe a lista de pedidos e os bot√µes de a√ß√£o.
-   `process.php`: Script respons√°vel por buscar pedidos eleg√≠veis, construir o payload da API, enviar a requisi√ß√£o e atualizar o banco de dados.
-   `reset.php`: Script para resetar o banco de dados, recarregando as tabelas e dados iniciais a partir dos arquivos SQL.
-   `sql/`: Diret√≥rio que cont√©m os scripts SQL para cria√ß√£o das tabelas e inser√ß√£o dos dados de teste.


## üöÄ Como Usar

Ap√≥s a instala√ß√£o e configura√ß√£o, siga os passos abaixo para interagir com o sistema:

1.  **Acesse a Dashboard**: Abra seu navegador e navegue para `http://seu-servidor-ip-ou-dominio/pagcompleto/`.

2.  **Resetar o Banco de Dados**: √â necess√°rio resetar o Banco antes de processar os dados para de fato observar o funcionamento. Clique no bot√£o **"Resetar Banco de Dados"** na dashboard. Isso ir√°:
    -   Limpar todas as tabelas existentes.
    -   Recarregar os dados a partir dos arquivos `.sql` na pasta `sql/`.
    -   Voc√™ ver√° uma mensagem de sucesso na tela.

3.  **Visualizar Pedidos**: Ap√≥s o reset, a dashboard exibir√° uma lista de pedidos. Os pedidos eleg√≠veis para processamento (que atendem aos crit√©rios de elegibilidade) ser√£o destacados.

4.  **Processar Pedidos Eleg√≠veis**: Clique no bot√£o **"Processar Pedidos Eleg√≠veis"** na dashboard. O sistema ir√°:
    -   Buscar todos os pedidos que atendem aos crit√©rios de elegibilidade.
    -   Para cada pedido, simular (em modo de desenvolvimento) ou enviar (em modo de produ√ß√£o) uma requisi√ß√£o para a API do PAGCOMPLETO.
    -   Atualizar o status do pedido no banco de dados com base na resposta da API.
    -   Voc√™ ver√° uma mensagem de sucesso ou erro na tela.

5.  **Modo de Desenvolvimento**: Por padr√£o, o projeto est√° configurado com `DEVELOPMENT_MODE = true` no `config.php`. Isso significa que as chamadas para a API do PAGCOMPLETO s√£o simuladas, permitindo testar a l√≥gica sem afetar o ambiente real. Para desativar o modo de desenvolvimento e realizar chamadas reais, altere `DEVELOPMENT_MODE` para `false` no `config.php`.

## Considera√ß√µes de Seguran√ßa

-   **Preven√ß√£o de SQL Injection**: O uso de PDO (PHP Data Objects) com *prepared statements* √© fundamental para proteger o banco de dados contra ataques de SQL Injection. Isso garante que as consultas SQL sejam constru√≠das de forma segura, separando o c√≥digo SQL dos dados fornecidos pelo usu√°rio.
-   **Valida√ß√£o e Sanitiza√ß√£o de Entradas**: Embora o projeto atual lide principalmente com dados internos do banco, em um cen√°rio real, todas as entradas de usu√°rio (formul√°rios, par√¢metros de URL) devem ser rigorosamente validadas e sanitizadas para prevenir ataques como Cross-Site Scripting (XSS) e outros.
-   **Tratamento de Erros Controlado**: Mensagens de erro detalhadas s√£o √∫teis para depura√ß√£o, mas n√£o devem ser expostas diretamente ao usu√°rio final em ambiente de produ√ß√£o. O projeto utiliza `error_reporting(E_ALL)` e `ini_set("display_errors", 1)` para desenvolvimento, mas isso deve ser desativado em produ√ß√£o (`display_errors = Off`) para evitar vazamento de informa√ß√µes sens√≠veis.
-   **Credenciais Seguras**: As credenciais de banco de dados e tokens de API s√£o armazenados no `config.php`. Para ambientes de produ√ß√£o, √© altamente recomend√°vel utilizar vari√°veis de ambiente ou um sistema de gerenciamento de segredos para armazenar essas informa√ß√µes, evitando que elas fiquem diretamente no c√≥digo-fonte.
-   **Modo de Desenvolvimento**: O `DEVELOPMENT_MODE` garante que nenhuma transa√ß√£o real seja enviada para a API externa durante o desenvolvimento e teste, protegendo o ambiente de produ√ß√£o de dados indesejados ou chamadas acidentais.
-   **Transa√ß√µes de Banco de Dados**: As opera√ß√µes de atualiza√ß√£o de status de pedidos s√£o encapsuladas em transa√ß√µes de banco de dados. Isso garante a atomicidade das opera√ß√µes: ou todas as altera√ß√µes s√£o aplicadas com sucesso, ou nenhuma delas √©, mantendo a integridade dos dados mesmo em caso de falhas.

## üõ†Ô∏è Desenvolvimento e Depura√ß√£o

Para desenvolvedores que desejam estender ou depurar o projeto, as seguintes dicas s√£o √∫teis:

-   **Exibi√ß√£o de Erros**: Certifique-se de que `display_errors = On` e `error_reporting = E_ALL` estejam configurados no seu `php.ini` (e no topo de cada arquivo PHP) durante o desenvolvimento para ver todos os avisos e erros. Lembre-se de desativ√°-los em produ√ß√£o.
-   **Modo de Desenvolvimento**: Mantenha `DEVELOPMENT_MODE = true` no `config.php` para simular as respostas da API e evitar chamadas reais durante o desenvolvimento.
-   **Logs de Erro**: Verifique os logs de erro do Apache (`/var/log/apache2/error.log`) e e do m√≥dulo PHP para mensagens detalhadas sobre falhas de execu√ß√£o.
-   **Depura√ß√£o de Banco de Dados**: Utilize ferramentas como `psql` ou um cliente gr√°fico (ex: DBeaver) para inspecionar o estado do banco de dados e verificar se as opera√ß√µes est√£o sendo realizadas corretamente.
-   **Coment√°rios no C√≥digo**: O c√≥digo est√° comentado atrav√©s para facilitar o entendimento das funcionalidades e decis√µes.

---

Desenvolvido em Agosto de 2025 por Henrique Stanke Scandelari como parte de um teste t√©cnico para uma vaga de Programador PHP J√∫nior.

Godspeed!
>>>>>>> 6a6139c (Commit Inicial)
